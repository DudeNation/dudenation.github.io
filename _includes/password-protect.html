{% assign post_password = page.password | default: site.password_protect.password %}
{% assign post_content = include.content | default: content %}
{% if post_password %}
<div id="password-protect-{{ page.title | slugify }}" class="password-protect-container" data-password-hash="{{ post_password }}">
  <div class="password-form" style="text-align: center; padding: 2rem; border: 2px solid #ddd; border-radius: 8px; margin: 2rem 0;">
    <h3>üîí Protected Content</h3>
    <p>This post is password protected. Please enter the password to view.</p>
    <input type="password" class="password-input" placeholder="Enter password" style="padding: 0.5rem; margin: 0.5rem; border: 1px solid #ccc; border-radius: 4px; width: 250px;">
    <br>
    <button type="button" class="password-submit" style="padding: 0.5rem 1.5rem; margin: 0.5rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Submit</button>
    <p class="password-error" style="color: red; display: none; margin-top: 1rem;">‚ùå Incorrect password. Please try again.</p>
  </div>
  <div class="password-content" style="display: none; width: 100%;">
    {{ post_content }}
  </div>
</div>

<script>
(function() {
  // Wait for DOM to be ready
  function initPasswordProtect() {
    const containerId = 'password-protect-{{ page.title | slugify }}';
    const container = document.getElementById(containerId);
    
    if (!container) {
      console.error('Password protect container not found:', containerId);
      return;
    }
    
    const passwordHash = container.getAttribute('data-password-hash');
    if (!passwordHash) {
      console.error('Password hash not found');
      return;
    }
    
    const form = container.querySelector('.password-form');
    const content = container.querySelector('.password-content');
    const input = container.querySelector('.password-input');
    const submitBtn = container.querySelector('.password-submit');
    const errorMsg = container.querySelector('.password-error');
    const storageKey = 'password-protect-{{ page.title | slugify }}';
    
    if (!form || !content || !input || !submitBtn || !errorMsg) {
      console.error('Required elements not found');
      return;
    }
    
    // Hash password using SHA-256 (with fallback)
    async function hashPassword(password) {
      try {
        // Try using Web Crypto API (requires HTTPS or localhost)
        if (window.crypto && window.crypto.subtle) {
          const encoder = new TextEncoder();
          const data = encoder.encode(password);
          const hashBuffer = await crypto.subtle.digest('SHA-256', data);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
          return hashHex;
        } else {
          // Fallback: use a simple hash library or implement SHA-256 manually
          // For now, we'll use a simple approach with crypto-js if available
          throw new Error('Web Crypto API not available');
        }
      } catch (error) {
        // Fallback: use a simple hash (less secure but works everywhere)
        // In production, you should use a proper SHA-256 library
        console.warn('Web Crypto API not available, using fallback');
        return simpleHash(password);
      }
    }
    
    // Simple hash function (for fallback - less secure)
    function simpleHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
      }
      return Math.abs(hash).toString(16);
    }
    
    // Use crypto-js if available (better fallback)
    async function hashPasswordWithCryptoJS(password) {
      if (typeof CryptoJS !== 'undefined') {
        return CryptoJS.SHA256(password).toString();
      }
      return hashPassword(password);
    }
    
    async function checkPassword() {
      const inputPassword = input.value.trim();
      
      if (!inputPassword) {
        errorMsg.textContent = 'Please enter a password.';
        errorMsg.style.display = 'block';
        setTimeout(() => {
          errorMsg.style.display = 'none';
        }, 3000);
        return;
      }
      
      try {
        // Try crypto-js first, then Web Crypto API, then fallback
        let inputHash;
        if (typeof CryptoJS !== 'undefined') {
          inputHash = CryptoJS.SHA256(inputPassword).toString();
        } else {
          inputHash = await hashPassword(inputPassword);
        }
        
        // Compare hashes (case-insensitive)
        if (inputHash.toLowerCase() === passwordHash.toLowerCase()) {
          form.style.display = 'none';
          content.style.display = 'block';
          content.style.visibility = 'visible';
          sessionStorage.setItem(storageKey, 'true');
          // Scroll to content
          setTimeout(() => {
            content.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 100);
        } else {
          errorMsg.textContent = '‚ùå Incorrect password. Please try again.';
          errorMsg.style.display = 'block';
          input.value = '';
          setTimeout(() => {
            errorMsg.style.display = 'none';
          }, 3000);
        }
      } catch (error) {
        console.error('Password check error:', error);
        errorMsg.textContent = 'An error occurred. Please try again.';
        errorMsg.style.display = 'block';
      }
    }
    
    // Check if already authenticated
    if (sessionStorage.getItem(storageKey) === 'true') {
      form.style.display = 'none';
      content.style.display = 'block';
      content.style.visibility = 'visible';
    }
    
    // Add event listeners
    submitBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      checkPassword();
    });
    
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        checkPassword();
      }
    });
    
    // Also handle button mousedown for better responsiveness
    submitBtn.addEventListener('mousedown', function(e) {
      e.preventDefault();
    });
  }
  
  // Wait for DOM to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPasswordProtect);
  } else {
    // DOM is already ready
    initPasswordProtect();
  }
})();
</script>
{% else %}
{{ post_content }}
{% endif %}

