{% assign post_password = page.password | default: site.password_protect.password %}
{% assign post_content = include.content | default: content %}
{% if post_password %}
<div id="password-protect-{{ page.title | slugify }}" class="password-protect-container" data-password-hash="{{ post_password }}">
  <div class="password-form" style="text-align: center; padding: 2rem; border: 2px solid #ddd; border-radius: 8px; margin: 2rem 0;">
    <h3>üîí Protected Content</h3>
    <p>This post is password protected. Please enter the password to view.</p>
    <input type="password" class="password-input" placeholder="Enter password" style="padding: 0.5rem; margin: 0.5rem; border: 1px solid #ccc; border-radius: 4px; width: 250px;">
    <br>
    <button class="password-submit" style="padding: 0.5rem 1.5rem; margin: 0.5rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Submit</button>
    <p class="password-error" style="color: red; display: none; margin-top: 1rem;">‚ùå Incorrect password. Please try again.</p>
  </div>
  <div class="password-content" style="display: none;">
    {{ post_content }}
  </div>
</div>

<script>
(function() {
  const container = document.getElementById('password-protect-{{ page.title | slugify }}');
  if (!container) return;
  
  const passwordHash = container.getAttribute('data-password-hash');
  const form = container.querySelector('.password-form');
  const content = container.querySelector('.password-content');
  const input = container.querySelector('.password-input');
  const submitBtn = container.querySelector('.password-submit');
  const errorMsg = container.querySelector('.password-error');
  const storageKey = 'password-protect-{{ page.title | slugify }}';
  
  // Hash password using SHA-256
  async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex;
  }
  
  async function checkPassword() {
    const inputPassword = input.value;
    if (!inputPassword) return;
    
    const inputHash = await hashPassword(inputPassword);
    
    if (inputHash === passwordHash) {
      form.style.display = 'none';
      content.style.display = 'block';
      sessionStorage.setItem(storageKey, 'true');
    } else {
      errorMsg.style.display = 'block';
      input.value = '';
      setTimeout(() => {
        errorMsg.style.display = 'none';
      }, 3000);
    }
  }
  
  // Check if already authenticated
  if (sessionStorage.getItem(storageKey) === 'true') {
    form.style.display = 'none';
    content.style.display = 'block';
  }
  
  submitBtn.addEventListener('click', checkPassword);
  input.addEventListener('keypress', async function(e) {
    if (e.key === 'Enter') {
      await checkPassword();
    }
  });
})();
</script>
{% else %}
{{ post_content }}
{% endif %}

